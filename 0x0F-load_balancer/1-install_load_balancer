#!/usr/bin/env bash
# Install and configure HAproxy on your lb-01 server
sudo apt-get install --no-install-recommends software-properties-common
sudo add-apt-repository ppa:vbernat/haproxy-2.7
sudo apt update
sudo apt-get install haproxy=2.7.\*

# Configures HAproxy so that it send traffic to web-01 and web-02 and distribute requests using a roundrobin algorithm
cat << EOF |sudo tee -a /etc/haproxy/haproxy.cfg
listen load_balancer
        bind :80
	mode http
	option httpclose
	option forwardfor
        balance roundrobin
        server 140268-web-01 54.237.45.220:80 check
        server 140268-web-01 54.237.63.152:80 check
EOF

# Managing HAproxy via an init script
echo "ENABLED=1" | sudo tee -a /etc/default/haproxy
sudo systemctl restart haproxy
