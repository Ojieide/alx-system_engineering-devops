#!/usr/bin/env bash
# Install and configure HAproxy on your lb-01 server
sudo apt update && sudo apt upgrade
sudo apt-get install --no-install-recommends software-properties-common
sudo add-apt-repository ppa:vbernat/haproxy-2.6
sudo apt update
sudo apt-get install haproxy=2.6.\*

# Configures HAproxy so that it send traffic to web-01 and web-02 and distribute requests using a roundrobin algorithm
CONFIG="
frontend alx-frontend
  bind *:80
  mode http
  default_backend alx-backend
backend alx-backend
  balance roundrobin
  server web-01 54.237.45.220:80 check
  server web-02 54.237.63.152:80 check
"
echo "$CONFIG" | sudo tee -a /etc/haproxy/haproxy.cfg > /dev/null

# Set HAproxy to be managed via an init script
echo "ENABLED=1" | sudo tee -a /etc/default/haproxy
sudo service haproxy restart
